trigger: 
  branches:
    include: [main,master]
  paths:
    include: [aks/800-devops-kubectl, aks/demo-flask-app, aks/demo-job]

pr:
  paths:
    include: [aks/800-devops-kubectl, aks/demo-flask-app, aks/demo-job]

variables:
- name: MajorVersion
  value: '1'
- name: MinorVersion
  value: '0'
- name: PatchNumber
  value: '1'
- name: PYTHONVERSION
  value: '3.9'
- name: BuildName
  ${{ if eq(variables['Build.SourceBranchName'],'main') }}:
    value: "${{ variables.MajorVersion}}.${{ variables.MinorVersion }}.${{ variables.PatchNumber }}.$(Build.BuildId)"
  ${{else}}:
    value: "${{ variables.MajorVersion}}.${{ variables.MinorVersion }}.${{ variables.PatchNumber }}-prerelease.$(Build.BuildId)"

name: "${{ variables.BUILDNAME }}"

stages:
- stage: BUILD
  displayName: Build stage
  pool: 
    name: Azure Pipelines
    vmImage: ubuntu-latest
  jobs:
    - template: ./build-template.yml

- stage: DEV_DEPLOY
  displayName: Dev Deploy stage
  variables:
    ENVIRONMENT: prod
  pool: 
    name: Azure Pipelines
    vmImage: ubuntu-latest
  jobs:
    - template: ./deploy-template.yml

- stage: PROD_DEPLOY
  dependsOn: DEV_DEPLOY
  displayName: Prod Deploy stage
  variables:
    ENVIRONMENT: prod
    isMainBranch: $[eq(variables['Build.SourceBranchName'], 'refs/heads/main')]
  pool: 
    name: Azure Pipelines
    vmImage: ubuntu-latest
  jobs:
    - template: ./deploy-template.yml